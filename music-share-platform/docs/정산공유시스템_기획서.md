# 정산 공유 시스템 기획서

## 📋 프로젝트 개요

### 목적
- 루트레이블(관리사)이 소속 아티스트 및 협력 업체에게 정산 데이터를 개별적으로 공유
- 각 파트너(아티스트/업체)가 본인의 정산 내역만 안전하게 조회
- 정산 데이터의 투명성 확보 및 업무 효율화

### 핵심 가치
```
┌─────────────────────────────────────────────────────────────┐
│                    정산 공유 시스템                          │
├─────────────────────────────────────────────────────────────┤
│  관리자 (루트레이블)                                         │
│    ↓ 정산 데이터 할당                                        │
│  파트너 계정 (아티스트/업체)                                  │
│    ↓ 본인 데이터만 조회                                      │
│  정산 대시보드                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 👥 사용자 역할

### 1. 관리자 (Admin)
- **대상**: 루트레이블 담당자
- **권한**:
  - 모든 정산 데이터 조회/관리
  - 파트너 계정 생성 및 관리
  - 파트너별 정산 데이터 할당
  - 정산 보고서 생성/전송

### 2. 파트너 (Partner)
- **대상**: 아티스트, 작곡가, 협력 업체 등
- **유형**:
  - `artist`: 개인 아티스트
  - `company`: 협력 업체/소속사
  - `composer`: 작곡가/작사가
- **권한**:
  - 본인에게 할당된 정산 데이터만 조회
  - 정산 보고서 다운로드
  - 정산 내역 문의

---

## 🗄️ 데이터베이스 설계

### 신규 테이블

#### 1. partners (파트너 정보)
```sql
CREATE TABLE partners (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,  -- 로그인 계정 연결
  partner_type VARCHAR(20) NOT NULL,                     -- artist, company, composer
  business_name VARCHAR(255),                            -- 상호명/활동명
  contact_name VARCHAR(100),                             -- 담당자명
  contact_email VARCHAR(255),                            -- 연락용 이메일
  contact_phone VARCHAR(50),                             -- 연락처
  bank_name VARCHAR(100),                                -- 정산 은행
  bank_account VARCHAR(50),                              -- 계좌번호
  commission_rate DECIMAL(5,2) DEFAULT 0,                -- 개별 수수료율 (%)
  contract_start_date DATE,                              -- 계약 시작일
  contract_end_date DATE,                                -- 계약 종료일
  notes TEXT,                                            -- 메모
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 2. partner_tracks (파트너-트랙 연결)
```sql
CREATE TABLE partner_tracks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  partner_id UUID REFERENCES partners(id) ON DELETE CASCADE,
  track_id UUID REFERENCES tracks(id) ON DELETE CASCADE,
  revenue_share DECIMAL(5,2) DEFAULT 100,                -- 수익 분배율 (%)
  role VARCHAR(50) DEFAULT 'owner',                      -- owner, featured, composer 등
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(partner_id, track_id)
);
```

#### 3. partner_settlements (파트너별 정산 내역)
```sql
CREATE TABLE partner_settlements (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  partner_id UUID REFERENCES partners(id) ON DELETE CASCADE,
  year_month VARCHAR(7) NOT NULL,
  settlement_type VARCHAR(20) DEFAULT 'monthly',         -- monthly, quarterly, yearly

  -- 정산 금액
  total_gross_revenue DECIMAL(15,2) DEFAULT 0,           -- 총 매출
  total_net_revenue DECIMAL(15,2) DEFAULT 0,             -- 순 매출
  partner_share DECIMAL(15,2) DEFAULT 0,                 -- 파트너 정산금
  management_fee DECIMAL(15,2) DEFAULT 0,                -- 관리사 수수료

  -- 상세 정보
  track_count INTEGER DEFAULT 0,                          -- 정산 트랙 수
  total_streams BIGINT DEFAULT 0,                         -- 총 스트리밍
  total_downloads BIGINT DEFAULT 0,                       -- 총 다운로드

  -- 상태 관리
  status VARCHAR(20) DEFAULT 'pending',                   -- pending, confirmed, paid
  confirmed_at TIMESTAMP,                                 -- 파트너 확인 일시
  paid_at TIMESTAMP,                                      -- 지급 완료 일시
  payment_reference VARCHAR(255),                         -- 지급 참조번호

  -- 메모
  admin_notes TEXT,                                       -- 관리자 메모
  partner_notes TEXT,                                     -- 파트너 메모/문의

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(partner_id, year_month, settlement_type)
);
```

#### 4. partner_settlement_details (정산 상세 내역)
```sql
CREATE TABLE partner_settlement_details (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  partner_settlement_id UUID REFERENCES partner_settlements(id) ON DELETE CASCADE,
  monthly_settlement_id UUID REFERENCES monthly_settlements(id),  -- 원본 정산 데이터

  track_id UUID REFERENCES tracks(id),
  distributor_id UUID REFERENCES distributors(id),

  gross_revenue DECIMAL(15,2) DEFAULT 0,
  net_revenue DECIMAL(15,2) DEFAULT 0,
  partner_share DECIMAL(15,2) DEFAULT 0,

  stream_count BIGINT DEFAULT 0,
  download_count BIGINT DEFAULT 0,

  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 5. settlement_notifications (정산 알림)
```sql
CREATE TABLE settlement_notifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  partner_id UUID REFERENCES partners(id) ON DELETE CASCADE,
  partner_settlement_id UUID REFERENCES partner_settlements(id),

  notification_type VARCHAR(50),                          -- new_settlement, payment_complete, etc.
  title VARCHAR(255),
  message TEXT,

  is_read BOOLEAN DEFAULT FALSE,
  read_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT NOW()
);
```

### 기존 users 테이블 수정
```sql
-- role 컬럼에 'partner' 추가
ALTER TABLE users
ALTER COLUMN role TYPE VARCHAR(20);

-- role 값: 'admin', 'user', 'partner'
```

---

## 📡 API 설계

### 관리자 API

#### 파트너 관리
```
GET    /api/admin/partners              - 파트너 목록 조회
POST   /api/admin/partners              - 파트너 생성 (계정 포함)
GET    /api/admin/partners/:id          - 파트너 상세 조회
PUT    /api/admin/partners/:id          - 파트너 정보 수정
DELETE /api/admin/partners/:id          - 파트너 삭제

POST   /api/admin/partners/:id/tracks   - 파트너에 트랙 연결
DELETE /api/admin/partners/:id/tracks/:trackId - 트랙 연결 해제
```

#### 정산 할당
```
GET    /api/admin/settlements/assign              - 할당 대상 조회
POST   /api/admin/settlements/assign              - 정산 데이터 할당
POST   /api/admin/settlements/assign/bulk         - 일괄 할당
GET    /api/admin/settlements/partners/:partnerId - 파트너별 정산 조회
PUT    /api/admin/settlements/:id/status          - 정산 상태 변경
POST   /api/admin/settlements/:id/notify          - 정산 알림 발송
```

### 파트너 API

#### 인증
```
POST   /api/partner/auth/login          - 파트너 로그인
POST   /api/partner/auth/register       - 파트너 회원가입 (초대 코드)
PUT    /api/partner/auth/password       - 비밀번호 변경
```

#### 정산 조회
```
GET    /api/partner/dashboard           - 파트너 대시보드
GET    /api/partner/settlements         - 정산 내역 목록
GET    /api/partner/settlements/:id     - 정산 상세 조회
GET    /api/partner/settlements/:id/details - 상세 내역 (트랙별)
GET    /api/partner/settlements/export  - 정산 데이터 다운로드
PUT    /api/partner/settlements/:id/confirm - 정산 확인
```

#### 프로필/알림
```
GET    /api/partner/profile             - 내 정보 조회
PUT    /api/partner/profile             - 내 정보 수정
GET    /api/partner/notifications       - 알림 목록
PUT    /api/partner/notifications/:id/read - 알림 읽음 처리
```

---

## 🎨 UI/UX 설계

### 관리자 화면

#### 1. 파트너 관리 페이지
```
┌────────────────────────────────────────────────────────────┐
│  파트너 관리                                    [+ 새 파트너]│
├────────────────────────────────────────────────────────────┤
│  🔍 검색: [____________]  유형: [전체 ▼]  상태: [전체 ▼]   │
├────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 🎤 홍길동 (아티스트)                                 │  │
│  │    이메일: hong@email.com                            │  │
│  │    연결 트랙: 5개 | 계약: 2024.01 ~ 2025.12         │  │
│  │    [상세] [정산할당] [수정] [삭제]                   │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 🏢 (주)뮤직컴퍼니 (업체)                             │  │
│  │    담당자: 김철수 | kim@company.com                  │  │
│  │    연결 트랙: 12개 | 계약: 2023.06 ~ 2026.05        │  │
│  │    [상세] [정산할당] [수정] [삭제]                   │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────┘
```

#### 2. 정산 할당 페이지
```
┌────────────────────────────────────────────────────────────┐
│  정산 데이터 할당                                          │
├────────────────────────────────────────────────────────────┤
│  정산월: [2024-12 ▼]                                       │
│                                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 파트너 선택                        할당 미리보기    │   │
│  │ ┌───────────────────┐           ┌───────────────────┐│   │
│  │ │ ☑ 홍길동         │           │ 총 매출: ₩3.5M   ││   │
│  │ │ ☑ 뮤직컴퍼니     │     →     │ 순 매출: ₩2.8M   ││   │
│  │ │ ☐ 박영희         │           │ 파트너 정산: ₩2.1M││   │
│  │ │ ☐ 이소영         │           │ 관리사 수익: ₩0.7M││   │
│  │ └───────────────────┘           └───────────────────┘│   │
│  └─────────────────────────────────────────────────────┘   │
│                                                            │
│  [미리보기] [할당 실행] [알림 발송]                        │
└────────────────────────────────────────────────────────────┘
```

### 파트너 화면

#### 1. 파트너 로그인 페이지
```
┌────────────────────────────────────────────────────────────┐
│                                                            │
│                    🎵 ROUTELABEL                           │
│                    파트너 정산 시스템                       │
│                                                            │
│              ┌────────────────────────────┐                │
│              │  이메일                     │                │
│              │  [____________________]    │                │
│              │                            │                │
│              │  비밀번호                   │                │
│              │  [____________________]    │                │
│              │                            │                │
│              │  [      로그인      ]      │                │
│              │                            │                │
│              │  초대 코드로 가입하기        │                │
│              └────────────────────────────┘                │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### 2. 파트너 대시보드
```
┌────────────────────────────────────────────────────────────┐
│  🎤 홍길동님 환영합니다                      [로그아웃] 🔔  │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 이번 달 정산  │  │ 누적 정산    │  │ 연결 트랙    │      │
│  │ ₩1,250,000  │  │ ₩15,800,000 │  │    5개       │      │
│  │   +12.5%    │  │   2024년     │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                            │
│  📊 월별 정산 추이                                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                    📈 차트                            │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                            │
│  📋 최근 정산 내역                                         │
│  ┌────────────────────────────────────────────────────┐    │
│  │ 2024-12 | ₩1,250,000 | 확인완료 | [상세보기]     │    │
│  │ 2024-11 | ₩1,100,000 | 지급완료 | [상세보기]     │    │
│  │ 2024-10 | ₩980,000   | 지급완료 | [상세보기]     │    │
│  └────────────────────────────────────────────────────┘    │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### 3. 정산 상세 페이지
```
┌────────────────────────────────────────────────────────────┐
│  ← 2024년 12월 정산 상세                    [엑셀 다운로드] │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  정산 요약                                                 │
│  ┌────────────────────────────────────────────────────┐    │
│  │  총 매출      순 매출       파트너 정산     상태    │    │
│  │  ₩1,500,000  ₩1,200,000   ₩1,250,000    확인대기  │    │
│  └────────────────────────────────────────────────────┘    │
│                                                            │
│  유통사별 상세                                             │
│  ┌────────────────────────────────────────────────────┐    │
│  │ 유통사   │ 스트리밍  │ 다운로드 │ 매출    │ 정산   │    │
│  ├──────────┼──────────┼─────────┼─────────┼────────┤    │
│  │ 멜론     │ 50,000   │ 1,000   │ ₩500K  │ ₩400K │    │
│  │ 지니     │ 30,000   │ 500     │ ₩300K  │ ₩240K │    │
│  │ 스포티파이│ 20,000   │ 200     │ ₩200K  │ ₩160K │    │
│  └────────────────────────────────────────────────────┘    │
│                                                            │
│  트랙별 상세                                               │
│  ┌────────────────────────────────────────────────────┐    │
│  │ 곡명         │ 스트리밍  │ 다운로드 │ 정산금    │    │
│  ├──────────────┼──────────┼─────────┼───────────┤    │
│  │ Summer Night │ 80,000   │ 1,500   │ ₩800K    │    │
│  │ Autumn Breeze│ 20,000   │ 200     │ ₩450K    │    │
│  └────────────────────────────────────────────────────┘    │
│                                                            │
│  [정산 내역 확인] ← 파트너가 정산 확인 시 클릭             │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

## 🔐 보안 설계

### 인증/인가
1. **JWT 기반 인증**: 파트너 전용 토큰 발급
2. **역할 기반 접근 제어**: admin, partner 역할 분리
3. **데이터 격리**: 파트너는 본인 데이터만 접근 가능

### 데이터 보호
1. **암호화**: 민감 정보(은행 정보 등) 암호화 저장
2. **감사 로그**: 정산 데이터 접근 기록
3. **세션 관리**: 비활성 세션 자동 만료

---

## 🚀 구현 로드맵

### Phase 1: 기본 인프라 (1주)
- [ ] 데이터베이스 스키마 생성
- [ ] 파트너 사용자 역할 추가
- [ ] 기본 인증 시스템 구축

### Phase 2: 관리자 기능 (2주)
- [ ] 파트너 관리 CRUD API
- [ ] 파트너 관리 UI
- [ ] 트랙-파트너 연결 기능
- [ ] 정산 데이터 할당 기능

### Phase 3: 파트너 기능 (2주)
- [ ] 파트너 로그인/회원가입
- [ ] 파트너 대시보드
- [ ] 정산 내역 조회
- [ ] 정산 확인/문의 기능

### Phase 4: 고급 기능 (1주)
- [ ] 알림 시스템
- [ ] 엑셀 다운로드
- [ ] 정산 확인 워크플로우

### Phase 5: 마무리 (1주)
- [ ] 테스트 및 버그 수정
- [ ] 문서화
- [ ] 배포

---

## 📊 예상 작업량

| 영역 | 예상 시간 | 우선순위 |
|------|----------|---------|
| DB 스키마 | 4h | 높음 |
| 관리자 API | 16h | 높음 |
| 파트너 API | 12h | 높음 |
| 관리자 UI | 20h | 중간 |
| 파트너 UI | 24h | 중간 |
| 알림 시스템 | 8h | 낮음 |
| 테스트/QA | 12h | 높음 |
| **총계** | **~96h (12일)** | |

---

## 🤔 추가 고려사항

### 1. 초대 시스템
- 관리자가 파트너 초대 링크 생성
- 초대 링크로 회원가입 시 자동으로 파트너 역할 부여
- 기존 초대 시스템과 유사한 UX

### 2. 정산 워크플로우
```
정산 데이터 업로드 → 파트너별 자동 할당 → 알림 발송 →
파트너 확인 → 관리자 최종 승인 → 지급 처리
```

### 3. 향후 확장 가능성
- 정산 자동 계산 (수익 분배율 기반)
- 정산 이의제기 시스템
- 정산 일정 관리
- 계약 관리 시스템 연동

---

## 📝 결론

이 시스템을 통해:
1. **관리자**는 각 파트너에게 개별 정산 데이터를 안전하게 공유
2. **파트너**는 자신의 정산 내역만 투명하게 확인
3. **자동화**를 통한 업무 효율 향상
4. **데이터 격리**를 통한 보안 강화

구현 시작 전 추가 논의가 필요한 사항:
- 파트너 가입 방식 (초대만? 자유 가입?)
- 정산 확인 의무화 여부
- 지급 완료 처리 연동 방식
